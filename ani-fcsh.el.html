<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>ani-fcsh.el</title>
    <meta name="generator" content="emacs-wiki.el"/>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
    <link rel="stylesheet" type="text/css" href="../style.css" />
    <link rel="shortcut icon" href="favicon.ico"/>
    <link rev="made" href="../MaintainerPage.html"/>
    <link rel="home" href="../index.html"/>
    <link rel="index" href="../WikiIndex.html"/>
    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://anirudhs.chaosnet.org/blog/weblog.xml"/>
    <meta content="Anirudh Sasikumar" name="author"/>
    <meta content="Anirudh Sasikumar's Personal Website" name="description"/>
  </head>
  <body id="codearchives">
  <div id="container">
    <div id="banner">
      <h1>ani-fcsh.el</h1>
    </div>
    <hr />
      <br />
      <div id="menucontainer">
	<div class="navigationtitle">Navigator</div>
	<div class="navigationlinks">
	  <a href="../index.html">WelcomePage</a><br />
	  <a href="../AboutMe.html">AboutMe</a><br />
	  <a href="../AboutThisWebsite.html">AboutThisWebsite</a><br />
	  <a href="../CodeArchives.html">CodeArchives</a><br />
	  <a href="../CoursePage.html">CoursePage</a><br />
	  <a href="../KeyPage.html">KeyPage</a><br />
	  <a href="../LinksPage.html">LinksPage</a><br />
	  <a href="../QuotePage.html">QuotePage</a><br />
	  <a href="../SearchPage.html">SearchPage</a><br />
	</div>
	<div class="navigationtitle">Wiki</div>
	<div class="navigationlinks">
	  <a href="../index.html" id="nav-main">Main</a><br/>
	  <a href="../blog/index.html" id="nav-blog">Blog</a><br />
	</div>
	<div class="navigationfootertitle">Messages</div>
	<div class="navigationfooter">
	  <br />
	  May 16,2004:Site launched<br/>Dec 3,2004:Moved to new host<br/><br/>Disclaimer: All opinions and ideas expressed here are my own and do not necessarily reflect the views of Adobe Systems Incorporated.
	  <br /><br />
	  <a href="http://anirudhs.chaosnet.org/blog/weblog.xml">RSS 2.0 Feed</a><br />
	</div>
      </div>
      <div id="bodycontainer">
      <div class="contentframe">
	  <div class="content">
<!-- Page published by Emacs Wiki begins here -->
<pre class="fontlock">
<span class="comment-delimiter">;;; </span><span class="comment">ani-fcsh.el --- Lets compile work without restarting fcsh and recognize flex errors.
</span>
<span class="comment-delimiter">;; </span><span class="comment">Copyright (C) 2008 Anirudh Sasikumar
</span><span class="comment-delimiter">;; </span><span class="comment">Author: Anirudh Sasikumar
</span><span class="comment-delimiter">;; </span><span class="comment">URL: http://anirudhs.chaosnet.org/code/ani-fcsh.el
</span>
<span class="comment-delimiter">;; </span><span class="comment">Based on code in compile.el distributed along with emacs 22.1:
</span>
<span class="comment-delimiter">;; </span><span class="comment">Copyright (C) 1985, 1986, 1987, 1993, 1994, 1995, 1996, 1997, 1998, 1999,
</span><span class="comment-delimiter">;;   </span><span class="comment">2001, 2002, 2003, 2004, 2005, 2006, 2007  Free Software Foundation, Inc.
</span>
<span class="comment-delimiter">;; </span><span class="comment">Authors: Roland McGrath &lt;roland@gnu.org&gt;,
</span><span class="comment-delimiter">;;</span><span class="comment">	    Daniel Pfeiffer &lt;occitan@esperanto.org&gt;
</span><span class="comment-delimiter">;; </span><span class="comment">Maintainer: FSF
</span><span class="comment-delimiter">;; </span><span class="comment">Keywords: tools, processes
</span>
<span class="comment-delimiter">;; </span><span class="comment">This file is free software; you can redistribute it and/or modify
</span><span class="comment-delimiter">;; </span><span class="comment">it under the terms of the GNU General Public License as published by
</span><span class="comment-delimiter">;; </span><span class="comment">the Free Software Foundation; either version 2, or (at your option)
</span><span class="comment-delimiter">;; </span><span class="comment">any later version.
</span>
<span class="comment-delimiter">;; </span><span class="comment">This file is distributed in the hope that it will be useful,
</span><span class="comment-delimiter">;; </span><span class="comment">but WITHOUT ANY WARRANTY; without even the implied warranty of
</span><span class="comment-delimiter">;; </span><span class="comment">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
</span><span class="comment-delimiter">;; </span><span class="comment">GNU General Public License for more details.
</span>
<span class="comment-delimiter">;; </span><span class="comment">You should have received a copy of the GNU General Public License
</span><span class="comment-delimiter">;; </span><span class="comment">along with GNU Emacs; see the file COPYING.  If not, write to
</span><span class="comment-delimiter">;; </span><span class="comment">the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
</span><span class="comment-delimiter">;; </span><span class="comment">Boston, MA 02111-1307, USA.
</span>
<span class="comment-delimiter">;;; </span><span class="comment">Commentary:
</span>
<span class="comment-delimiter">;; </span><span class="comment">When visiting the main MXML file, call fcsh-compile. Then compile
</span><span class="comment-delimiter">;; </span><span class="comment">will invoke fcsh and run mxmlc. Subsequent compile's will send
</span><span class="comment-delimiter">;; </span><span class="comment">compile 1 without killing existing fcsh
</span>
<span class="comment-delimiter">;;; </span><span class="comment">Code:
</span>
(<span class="keyword">require</span> '<span class="constant">compile</span>)

(<span class="keyword">defvar</span> <span class="variable-name">*fcsh-compile-old-compilation-start*</span> nil 
  <span class="doc">&quot;Reference to actual compilation-start function that fcsh overrides&quot;</span>)

(<span class="keyword">defvar</span> <span class="variable-name">*fcsh-path*</span> <span class="string">&quot;c:\\anihome\\scripts\\fcsh.bat&quot;</span> 
  <span class="doc">&quot;Path to run fcsh. This is usually sdks/bin/fcsh.&quot;</span>)

(<span class="keyword">defvar</span> <span class="variable-name">*fcsh-compile-active*</span> nil 
  <span class="doc">&quot;true if `</span><span class="constant">fcsh-compile</span><span class="doc">' has been called. 
`</span><span class="constant">fcsh-compile</span><span class="doc">' calls `</span><span class="constant">fcsh-restore-compile</span><span class="doc">' if this is true.&quot;</span>)

(<span class="keyword">defvar</span> <span class="variable-name">*fcsh-mxmlc-command*</span> <span class="string">&quot;mxmlc&quot;</span> 
  <span class="doc">&quot;The command to run first when fcsh is started.&quot;</span>)

(<span class="keyword">defvar</span> <span class="variable-name">*fcsh-mxmlc-subsequent-command*</span> <span class="string">&quot;compile 1&quot;</span> 
  <span class="doc">&quot;The command to run when compile is called after the first time.&quot;</span>)

(<span class="keyword">defvar</span> <span class="variable-name">*fcsh-mxmlc-output-path*</span> <span class="string">&quot;..\\bin-debug\\&quot;</span> 
  <span class="doc">&quot;Output path to the swf. This is passed as an argument to `</span><span class="constant">*fcsh-mxmlc-command*</span><span class="doc">'. 
The swf's name is `</span><span class="constant">*fcsh-mxml-file*</span><span class="doc">' with mxml extension stripped off 
and swf extension added.&quot;</span>)

(<span class="keyword">defvar</span> <span class="variable-name">*fcsh-mxml-file*</span> <span class="string">&quot;&quot;</span> 
  <span class="doc">&quot;The name of the mxml file to pass to the first and only mxmlc command.&quot;</span>)

<span class="comment-delimiter">;; </span><span class="comment">To let compile understad flex error / warning messages. This regexp
</span><span class="comment-delimiter">;; </span><span class="comment">has been tested only on win.
</span>(add-to-list 'compilation-error-regexp-alist 'flex)
(add-to-list 'compilation-error-regexp-alist-alist
	     '(flex <span class="string">&quot;^</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">(</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">.*</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">):.* </span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">Error</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">|</span><span class="string">Warnin</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">g</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">: .*$&quot;</span> 1 2 nil (4)))

(<span class="keyword">defun</span> <span class="function-name">fcsh-compile</span> ()
  <span class="doc">&quot;Call this function from a buffer visiting the MXML file you
want to compile. 

It is best to have a mxmlfilename-config.xml to
pass arguments to mxmlc. 

Once this function is called, compile
will invoke fcsh and not kill it until the compilation buffer is
manually killed. Subsequent compile and recompile will use the
same fcsh instance and pass compile 1 to it. 

Use `</span><span class="constant">fcsh-restore-compile</span><span class="doc">' to restore compile's old behaviour. 
See `</span><span class="constant">*fcsh-compile-active*</span><span class="doc">'.&quot;</span>
  (interactive)
  (setq compile-command *fcsh-path*)
  (setq *fcsh-mxml-file* (buffer-name))
  (<span class="keyword">if</span> (not *fcsh-compile-active*)
      (<span class="keyword">progn</span>
	(setq *fcsh-compile-active* t)
	(fset '*fcsh-compile-old-compilation-start* (symbol-function 'compilation-start))
	(fset 'compilation-start 'fcsh-compilation-start)
	)
    )
  
  )

(<span class="keyword">defun</span> <span class="function-name">fcsh-restore-compile</span> ()
  <span class="doc">&quot;See `</span><span class="constant">fcsh-compile</span><span class="doc">', `</span><span class="constant">*fcsh-compile-active*</span><span class="doc">' for more info.&quot;</span>
  (interactive)
  (<span class="keyword">if</span> *fcsh-compile-active*
      (<span class="keyword">progn</span>
	(setq *fcsh-compile-active* nil)
	(fset 'compilation-start '*fcsh-compile-old-compilation-start*)
	)
    ))

(<span class="keyword">defun</span> <span class="function-name">fcsh-compilation-filter</span> (proc string)
  <span class="doc">&quot;Process filter for compilation buffers.
Inserts the text, but uses `</span><span class="constant">insert-before-markers</span><span class="doc">'.

Also checks for (fcsh) string to see if the compilation has ended.&quot;</span>
  (<span class="keyword">if</span> (buffer-name (process-buffer proc))
      (<span class="keyword">with-current-buffer</span> (process-buffer proc)
	(<span class="keyword">let</span> ((inhibit-read-only t))
	  (<span class="keyword">save-excursion</span>
	    (goto-char (process-mark proc))
	    (insert-before-markers string)
	    <span class="comment-delimiter">;; </span><span class="comment">change for bug reported by craig
</span>	    (<span class="keyword">if</span> (and (&gt;= (length string) (length <span class="string">&quot;(fcsh) &quot;</span>))
		     (string= (substring string (- (length string) (length <span class="string">&quot;(fcsh) &quot;</span>))) <span class="string">&quot;(fcsh) &quot;</span>))
		(<span class="keyword">progn</span>
		  (compilation-handle-exit (process-status proc)
					   (process-exit-status proc)
					   <span class="string">&quot;finished&quot;</span>)
		  (setq compilation-in-progress (delq proc compilation-in-progress))
		  ))
	    
	    (run-hooks 'compilation-filter-hook))))))


(<span class="keyword">defun</span> <span class="function-name">fcsh-compilation-start</span> (command <span class="type">&amp;optional</span> mode name-function highlight-regexp)
  <span class="doc">&quot;Same as compilation-start but instead of spawning a different
process each time, keeps on passing command to the existing fcsh
shell.&quot;</span>
  (or mode (setq mode 'compilation-mode))
  (<span class="keyword">let*</span> ((name-of-mode
	  (<span class="keyword">if</span> (eq mode t)
	      (<span class="keyword">prog1</span> <span class="string">&quot;compilation&quot;</span> (<span class="keyword">require</span> '<span class="constant">comint</span>))
	    (replace-regexp-in-string <span class="string">&quot;-mode$&quot;</span> <span class="string">&quot;&quot;</span> (symbol-name mode))))
	 (thisdir default-directory)
	 outwin outbuf)
    (<span class="keyword">with-current-buffer</span>
	(setq outbuf
	      (get-buffer-create
	       (compilation-buffer-name name-of-mode mode name-function)))
      (<span class="keyword">let</span> ((comp-proc (get-buffer-process (current-buffer))))	    <span class="comment-delimiter">;;</span><span class="comment">
</span>      	(<span class="keyword">if</span> comp-proc						    <span class="comment-delimiter">;;</span><span class="comment">
</span>      	    (<span class="keyword">if</span> (eq (process-status comp-proc) 'run)	    <span class="comment-delimiter">;;</span><span class="comment">
</span>		(setq mode t)<span class="comment-delimiter">;;</span><span class="comment">
</span>      	      )))
      (<span class="keyword">if</span> (not (eq mode t))
	  (<span class="keyword">progn</span>
	    (buffer-disable-undo (current-buffer))
	    <span class="comment-delimiter">;; </span><span class="comment">first transfer directory from where M-x compile was called
</span>	    (setq default-directory thisdir)
	    )
	)
      <span class="comment-delimiter">;; </span><span class="comment">Make compilation buffer read-only.  The filter can still write it.
</span>      <span class="comment-delimiter">;; </span><span class="comment">Clear out the compilation buffer.
</span>      (<span class="keyword">if</span> (not (eq mode t))
	  (<span class="keyword">let</span> ((inhibit-read-only t)
		(default-directory thisdir))
	    <span class="comment-delimiter">;; </span><span class="comment">Then evaluate a cd command if any, but don't perform it yet, else start-command
</span>	    <span class="comment-delimiter">;; </span><span class="comment">would do it again through the shell: (cd &quot;..&quot;) AND sh -c &quot;cd ..; make&quot;
</span>	    (cd (<span class="keyword">if</span> (string-match <span class="string">&quot;^\\s *cd</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(?:</span><span class="string">\\s +</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">(</span><span class="string">\\S +?</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="regexp-grouping-backslash">\\</span><span class="regexp-grouping-construct">)</span><span class="string">?\\s *[;&amp;\n]&quot;</span> command)
		    (<span class="keyword">if</span> (match-end 1)
			(substitute-env-vars (match-string 1 command))
		      <span class="string">&quot;~&quot;</span>)
		  default-directory))
	    (erase-buffer)
	    <span class="comment-delimiter">;; </span><span class="comment">Select the desired mode.
</span>	    (<span class="keyword">if</span> (not (eq mode t))
		(funcall mode)
	      (setq buffer-read-only nil)
	      (<span class="keyword">with-no-warnings</span> (comint-mode))
	      (compilation-shell-minor-mode))
	    (<span class="keyword">if</span> highlight-regexp
		(set (make-local-variable 'compilation-highlight-regexp)
		     highlight-regexp))
	    <span class="comment-delimiter">;; </span><span class="comment">Output a mode setter, for saving and later reloading this buffer.
</span>	    (insert <span class="string">&quot;-*- mode: &quot;</span> name-of-mode
		    <span class="string">&quot;; default-directory: &quot;</span> (prin1-to-string default-directory)
		    <span class="string">&quot; -*-\n&quot;</span>
		    (format <span class="string">&quot;%s started at %s\n\n&quot;</span>
			    mode-name
			    (substring (current-time-string) 0 19))
		    command <span class="string">&quot;\n&quot;</span>)
	    (setq thisdir default-directory))
	)
      (set-buffer-modified-p nil))
    <span class="comment-delimiter">;; </span><span class="comment">If we're already in the compilation buffer, go to the end
</span>    <span class="comment-delimiter">;; </span><span class="comment">of the buffer, so point will track the compilation output.
</span>    (<span class="keyword">if</span> (eq outbuf (current-buffer))
	(goto-char (point-max)))
    <span class="comment-delimiter">;; </span><span class="comment">Pop up the compilation buffer.
</span>    (setq outwin (display-buffer outbuf nil t))
    (<span class="keyword">with-current-buffer</span> outbuf
      (<span class="keyword">let</span> ((process-environment
	     (append
	      compilation-environment
	      (<span class="keyword">if</span> (<span class="keyword">if</span> (boundp 'system-uses-terminfo) <span class="comment-delimiter">; </span><span class="comment">`</span><span class="constant">if</span><span class="comment">' for compiler warning
</span>		      system-uses-terminfo)
		  (list <span class="string">&quot;TERM=dumb&quot;</span> <span class="string">&quot;TERMCAP=&quot;</span>
			(format <span class="string">&quot;COLUMNS=%d&quot;</span> (window-width)))
		(list <span class="string">&quot;TERM=emacs&quot;</span>
		      (format <span class="string">&quot;TERMCAP=emacs:co#%d:tc=unknown:&quot;</span>
			      (window-width))))
	      <span class="comment-delimiter">;; </span><span class="comment">Set the EMACS variable, but
</span>	      <span class="comment-delimiter">;; </span><span class="comment">don't override users' setting of $EMACS.
</span>	      (<span class="keyword">unless</span> (getenv <span class="string">&quot;EMACS&quot;</span>)
		(list <span class="string">&quot;EMACS=t&quot;</span>))
	      (list <span class="string">&quot;INSIDE_EMACS=t&quot;</span>)
	      (copy-sequence process-environment)))
	    fcsh-initial-contents
	    )
	
	(<span class="keyword">if</span> (not (eq mode t))
	    (<span class="keyword">progn</span>
	      (set (make-local-variable 'compilation-arguments)
		   (list command mode name-function highlight-regexp))
	      (set (make-local-variable 'revert-buffer-function)
		   'compilation-revert-buffer)
	      
	      (set-window-start outwin (point-min))
	      (or (eq outwin (selected-window))
		  (set-window-point outwin (<span class="keyword">if</span> compilation-scroll-output
					       (point)
					     (point-min))))
	      
	      )
	  
	  )
	
	<span class="comment-delimiter">;; </span><span class="comment">The setup function is called before compilation-set-window-height
</span>	<span class="comment-delimiter">;; </span><span class="comment">so it can set the compilation-window-height buffer locally.
</span>	(<span class="keyword">if</span> compilation-process-setup-function
	    (funcall compilation-process-setup-function))
	(compilation-set-window-height outwin)
	(pop-to-buffer (current-buffer) t t)
	(goto-char (point-min))
	(next-line 2)
	(setq fcsh-initial-contents (buffer-substring (point-min) (point)))
	(setq buffer-read-only nil)
	
	(erase-buffer)
	(insert fcsh-initial-contents)
	(insert <span class="string">&quot;\n(fcsh) &quot;</span>)
	(goto-char (point-max))
	(setq buffer-read-only t)
	<span class="comment-delimiter">;; </span><span class="comment">Start the compilation.
</span>	(<span class="keyword">if</span> (fboundp 'start-process)
	    (<span class="keyword">let</span> ((proc (<span class="keyword">if</span> (eq mode t)
			    (get-buffer-process (current-buffer))
			  (start-process-shell-command (downcase mode-name)
						       outbuf command))))
	      <span class="comment-delimiter">;; </span><span class="comment">Make the buffer's mode line show process state.
</span>	      (setq mode-line-process '(<span class="string">&quot;:%s&quot;</span>))
	      (<span class="keyword">if</span> (not (eq mode t))
		  (<span class="keyword">progn</span>
		    (set-process-sentinel proc 'compilation-sentinel)
		    (set-process-filter proc 'fcsh-compilation-filter)))
	      
	      (<span class="keyword">if</span> (not (eq mode t) )
		  (<span class="keyword">progn</span>
		    (goto-char (point-max))
		    (setq buffer-read-only nil)
		    (insert (concat <span class="string">&quot;\n&quot;</span> (concat *fcsh-mxmlc-command* <span class="string">&quot; &quot;</span> 
						 *fcsh-mxml-file* <span class="string">&quot; -o &quot;</span> 
						 *fcsh-mxmlc-output-path* 
						 (file-name-sans-extension *fcsh-mxml-file*) 
						 <span class="string">&quot;.swf\n&quot;</span> )))
		    (setq buffer-read-only t)
		    (comint-send-string proc (concat *fcsh-mxmlc-command* <span class="string">&quot; &quot;</span> 
						     *fcsh-mxml-file* <span class="string">&quot; -o &quot;</span> 
						     *fcsh-mxmlc-output-path* 
						     (file-name-sans-extension *fcsh-mxml-file*) 
						     <span class="string">&quot;.swf\n&quot;</span> ))
		    )
		)
	      
	      (<span class="keyword">if</span> (eq mode t)
		  (<span class="keyword">progn</span>
		    (goto-char (point-max))
		    (setq buffer-read-only nil)
		    (insert (concat <span class="string">&quot;\n&quot;</span> *fcsh-mxmlc-subsequent-command* <span class="string">&quot;\n&quot;</span>))
		    (goto-char (point-max))
		    (setq buffer-read-only t)
		    (comint-send-string proc (concat *fcsh-mxmlc-subsequent-command* <span class="string">&quot;\n&quot;</span>))
		    ))
	      
	      (set-marker (process-mark proc) (point) outbuf)
	      (<span class="keyword">when</span> compilation-disable-input
                (<span class="keyword">condition-case</span> nil
                    (process-send-eof proc)
                  <span class="comment-delimiter">;; </span><span class="comment">The process may have exited already.
</span>                  (<span class="warning">error</span> nil)))
	      (setq compilation-in-progress
		    (cons proc compilation-in-progress)))
	  ))
      <span class="comment-delimiter">;; </span><span class="comment">Now finally cd to where the shell started make/grep/...
</span>      (setq default-directory thisdir))
    (<span class="keyword">if</span> (buffer-local-value 'compilation-scroll-output outbuf)
	(<span class="keyword">save-selected-window</span>
	  (select-window outwin)
	  (goto-char (point-max))))
    (other-window 1)
    <span class="comment-delimiter">;; </span><span class="comment">Make it so the next C-x ` will use this buffer.
</span>    (setq next-error-last-buffer outbuf)))

</pre><!-- Page published by Emacs Wiki ends here -->
</div><div class="hgrad"></div></div>
</div>
<div class="footerframe">
<div class="navigationlinks">
<a href="../index.html">Home</a> | <a href="../blog/index.html">Blog Home</a> | <a href="../blog/Archives.html">Archives</a>
</div>
Copyright &copy; 2004-2008 Anirudh Sasikumar. All rights reserved.<br/>
Last Updated: February 12, 2009 11:20 AM
<br />
<!-- Start of StatCounter Code -->
<script type="text/javascript">
var sc_project=322242; 
var sc_partition=1; 
</script>

<script type="text/javascript" src="http://www.statcounter.com/counter/counter_xhtml.js"></script><noscript><div class="statcounter"><a class="statcounter" href="http://www.statcounter.com/free_hit_counter.html"><img class="statcounter" src="http://c2.statcounter.com/counter.php?sc_project=322242&amp;amp;java=0" alt="free webpage hit counter" /></a></div></noscript>
<!-- End of StatCounter Code -->
</div>
</div>
</body>
</html>
